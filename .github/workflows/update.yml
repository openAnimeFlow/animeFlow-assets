name: Validate Plugin JSON

on:
  push:
    paths:
      - 'plugins/*.json'
  pull_request:
    paths:
      - 'plugins/*.json'

jobs:
  validate-json:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get changed JSON files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            plugins/*.json

      - name: Validate JSON format and structure
        run: |
          # å®šä¹‰å¿…éœ€çš„å­—æ®µåŠå…¶ç±»å‹
          declare -A REQUIRED_FIELDS_TYPES
          REQUIRED_FIELDS_TYPES["version"]="string"
          REQUIRED_FIELDS_TYPES["name"]="string"
          REQUIRED_FIELDS_TYPES["iconUrl"]="string"
          REQUIRED_FIELDS_TYPES["baseUrl"]="string"
          REQUIRED_FIELDS_TYPES["searchUrl"]="string"
          REQUIRED_FIELDS_TYPES["searchList"]="string"
          REQUIRED_FIELDS_TYPES["searchName"]="string"
          REQUIRED_FIELDS_TYPES["searchLink"]="string"
          REQUIRED_FIELDS_TYPES["lineNames"]="string"
          REQUIRED_FIELDS_TYPES["lineList"]="string"
          REQUIRED_FIELDS_TYPES["episode"]="string"
          
          # è½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾¿éå†
          REQUIRED_FIELDS=("version" "name" "iconUrl" "baseUrl" "searchUrl" "searchList" "searchName" "searchLink" "lineNames" "lineList" "episode")
          
          echo "ğŸ“‹ Plugin JSON format requirements:"
          echo "Required fields: ${REQUIRED_FIELDS[*]}"
          echo "All fields must be of type: string"
          echo ""
          
          # è·å–æ‰€æœ‰å˜æ›´çš„ JSON æ–‡ä»¶
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No JSON files changed, skipping validation"
            exit 0
          fi
          
          VALIDATION_FAILED=false
          
          # éå†æ¯ä¸ªå˜æ›´çš„ JSON æ–‡ä»¶ï¼ˆæ’é™¤ index.jsonï¼‰
          for file in $CHANGED_FILES; do
            if [[ "$file" == *"index.json"* ]]; then
              echo "â­ï¸  Skipping index.json validation"
              continue
            fi
            
            # è·³è¿‡æ¨¡æ¿æ–‡ä»¶æœ¬èº«
            if [[ "$file" == "$TEMPLATE_FILE" ]]; then
              echo "â­ï¸  Skipping template file: $file"
              continue
            fi
            
            echo "ğŸ” Validating: $file"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$file" ]; then
              echo "   âŒ Error: File $file does not exist"
              VALIDATION_FAILED=true
              echo ""
              continue
            fi
            
            # éªŒè¯ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®
            if ! jq empty "$file" 2>/dev/null; then
              echo "   âŒ Error: $file is not valid JSON"
              jq empty "$file" 2>&1 | sed 's/^/      /'
              VALIDATION_FAILED=true
              echo ""
              continue
            fi
            
            # è·å–å¾…éªŒè¯æ–‡ä»¶çš„æ‰€æœ‰é”®
            FILE_KEYS=$(jq -r 'keys[]' "$file")
            
            # æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨ä¸”ç±»å‹åŒ¹é…
            for field in "${REQUIRED_FIELDS[@]}"; do
              expected_type="${REQUIRED_FIELDS_TYPES[$field]}"
              
              if ! jq -e ".$field" "$file" > /dev/null 2>&1; then
                echo "   âŒ Error: Missing required field: $field"
                VALIDATION_FAILED=true
              else
                # éªŒè¯å­—æ®µç±»å‹æ˜¯å¦ä¸è§„èŒƒåŒ¹é…
                file_field_type=$(jq -r ".$field | type" "$file")
                
                if [ "$file_field_type" == "null" ]; then
                  echo "   âŒ Error: Field '$field' has null value (required non-null)"
                  VALIDATION_FAILED=true
                elif [ "$file_field_type" != "$expected_type" ]; then
                  echo "   âŒ Error: Field '$field' type mismatch. Expected: $expected_type, Got: $file_field_type"
                  VALIDATION_FAILED=true
                fi
              fi
            done
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é¢å¤–çš„å­—æ®µï¼ˆç»™å‡ºè­¦å‘Šï¼Œä½†ä¸é˜»æ­¢ï¼‰
            for key in $FILE_KEYS; do
              if [[ ! " ${REQUIRED_FIELDS[@]} " =~ " ${key} " ]]; then
                echo "   âš ï¸  Warning: Extra field '$key' found (not in template)"
              fi
            done
            
            # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ï¼ˆåº”è¯¥æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚ "1.0.0"ï¼‰
            version=$(jq -r '.version' "$file")
            if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "   âš ï¸  Warning: version format should be semantic (e.g., '1.0.0'), got: '$version'"
            fi
            
            # éªŒè¯ URL å­—æ®µæ ¼å¼
            iconUrl=$(jq -r '.iconUrl' "$file")
            if [[ ! "$iconUrl" =~ ^https?:// ]]; then
              echo "   âš ï¸  Warning: iconUrl should be a valid HTTP(S) URL, got: '$iconUrl'"
            fi
            
            baseUrl=$(jq -r '.baseUrl' "$file")
            if [[ ! "$baseUrl" =~ ^https?:// ]]; then
              echo "   âš ï¸  Warning: baseUrl should be a valid HTTP(S) URL, got: '$baseUrl'"
            fi
            
            searchUrl=$(jq -r '.searchUrl' "$file")
            if [[ ! "$searchUrl" =~ ^https?:// ]]; then
              echo "   âš ï¸  Warning: searchUrl should be a valid HTTP(S) URL, got: '$searchUrl'"
            elif [[ ! "$searchUrl" =~ \{keyword\} ]]; then
              echo "   âš ï¸  Warning: searchUrl should contain {keyword} placeholder, got: '$searchUrl'"
            fi
            
            if [ "$VALIDATION_FAILED" = false ]; then
              echo "   âœ… Validation passed"
            fi
            echo ""
          done
          
          if [ "$VALIDATION_FAILED" = true ]; then
            echo "âŒ Validation failed! Please fix the errors above."
            echo ""
            echo "ğŸ“ Expected format:"
            echo "{"
            for field in "${REQUIRED_FIELDS[@]}"; do
              echo "  \"$field\": \"<string value>\""
            done
            echo "}"
            exit 1
          else
            echo "âœ… All JSON files validated successfully!"
            echo ""
            echo "All plugin JSON files match the required format specification."
          fi
